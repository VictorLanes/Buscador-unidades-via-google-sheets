<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VeoLink | Unidades do Cliente</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#050915;
    --bg-alt:#0b1220;
    --card:#0f172a;
    --card-muted:#10192f;
    --text:#e8ecff;
    --muted:#94a3b8;
    --border:#1e293b;
    --accent:#38bdf8;
    --accent-dark:#0284c7;
    --danger:#f87171;
    --success:#34d399;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:radial-gradient(circle at top,var(--bg-alt),var(--bg));
    color:var(--text);
    display:flex;
    justify-content:center;
    padding:32px 16px 48px;
  }
  .shell{
    width:min(1120px,100%);
    display:flex;
    gap:32px;
    flex-direction:column;
  }
  header h1{
    margin:0;
    font-size:32px;
    letter-spacing:-.02em;
  }
  header p{
    margin:6px 0 0;
    color:var(--muted);
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:24px;
    box-shadow:0 20px 50px rgba(2,6,23,.6);
  }
  .card h2{
    margin:0 0 18px;
    font-size:20px;
  }
  label{
    display:grid;
    gap:6px;
    font-size:14px;
    color:var(--muted);
  }
  input,select,textarea{
    background:var(--card-muted);
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px 14px;
    font-size:15px;
    color:var(--text);
    font-family:inherit;
  }
  textarea{resize:vertical;min-height:90px;}
  button{
    border:none;
    border-radius:14px;
    padding:12px 18px;
    font-weight:600;
    color:#021526;
    background:var(--accent);
    cursor:pointer;
    transition:.15s ease;
  }
  button.secondary{
    background:transparent;
    color:var(--text);
    border:1px solid var(--border);
  }
  button.danger{
    background:var(--danger);
    color:#111;
  }
  button:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  button:hover:not(:disabled){filter:brightness(1.05);}
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:16px;
  }
  .grid.two{grid-template-columns:repeat(auto-fit,minmax(320px,1fr));}
  .grid.full label{grid-column:1 / -1;}
  .stack{display:flex;flex-direction:column;gap:18px;}
  .hidden{display:none!important;}
  .status{
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 16px;
    border-radius:12px;
    background:rgba(56,189,248,.08);
    border:1px solid rgba(56,189,248,.25);
    color:var(--muted);
    font-size:14px;
  }
  .status strong{color:var(--text);}
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 12px;
    border-radius:999px;
    font-size:12px;
    background:rgba(56,189,248,.1);
    border:1px solid rgba(56,189,248,.3);
    color:var(--text);
    text-transform:capitalize;
  }
  .layout{
    display:grid;
    grid-template-columns:minmax(320px,360px) minmax(0,1fr);
    gap:28px;
  }
  .list{
    display:flex;
    flex-direction:column;
    gap:14px;
    margin:0;
    padding:0;
    list-style:none;
  }
  .unit{
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
    background:var(--card-muted);
    display:flex;
    flex-direction:column;
    gap:8px;
    transition:border-color .2s ease, box-shadow .2s ease;
    cursor:pointer;
  }
  .unit.selected{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(56,189,248,.35);
  }
  .unit header{
    display:flex;
    align-items:flex-start;
    gap:12px;
    justify-content:space-between;
  }
  .unit-actions{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .unit-actions.preview-actions button{
    flex:1 1 120px;
  }
  .workspace{
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(280px,360px);
    gap:20px;
    align-items:flex-start;
  }
  .workspace-main{
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .workspace-preview{
    background:var(--card-muted);
    border:1px solid var(--border);
    border-radius:18px;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .workspace-preview h3{
    margin:0;
    font-size:18px;
  }
  .map-preview__frame{
    position:relative;
    border-radius:16px;
    overflow:hidden;
    background:radial-gradient(circle at top,rgba(56,189,248,.25),rgba(15,23,42,.9));
  }
  .map-preview__frame iframe{
    display:block;
    width:100%;
    aspect-ratio:4 / 3;
    border:0;
  }
  .map-preview__empty{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:32px;
    background:linear-gradient(135deg,rgba(15,23,42,.85),rgba(8,47,73,.85));
    color:var(--muted);
    font-size:15px;
  }
  .map-preview__info{
    display:flex;
    gap:16px;
    align-items:flex-start;
    justify-content:space-between;
  }
  .map-preview__info strong{
    font-size:18px;
    display:block;
    margin-bottom:6px;
  }
  .map-preview__info p{
    margin:4px 0 0;
  }
  .muted{color:var(--muted);}
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:center;
  }
  .toolbar input{
    flex:1 1 240px;
  }
  .toolbar select{
    width:160px;
  }
  .unit-editor{
    background:linear-gradient(135deg,rgba(56,189,248,.1),rgba(8,47,73,.3));
    border:1px solid rgba(56,189,248,.3);
    border-radius:18px;
    padding:24px;
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  .unit-editor__header{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
  }
  .unit-editor__header h2{
    margin:0;
    font-size:22px;
  }
  .unit-editor__grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:20px;
  }
  .unit-block{
    background:rgba(2,6,23,.4);
    border:1px solid rgba(148,163,184,.2);
    border-radius:16px;
    padding:18px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .unit-block h3{
    margin:0;
    font-size:16px;
    color:var(--muted);
    letter-spacing:.02em;
    text-transform:uppercase;
  }
  .unit-editor__actions{
    display:flex;
    justify-content:flex-end;
  }
  .floating-msg{
    margin-top:4px;
    min-height:20px;
    font-size:14px;
    color:var(--muted);
  }
  @media (max-width:960px){
    .layout{grid-template-columns:1fr;}
    .workspace{grid-template-columns:1fr;}
  }
  @media (max-width:720px){
    body{padding:24px 12px 36px;}
    header h1{font-size:26px;}
    header p{font-size:14px;}
    .card{padding:20px;}
    .status{flex-direction:column;align-items:flex-start;gap:6px;}
    .toolbar{flex-direction:column;align-items:stretch;}
    .toolbar input,.toolbar select{width:100%;}
    .grid.two{grid-template-columns:1fr;}
    .unit-editor__grid{grid-template-columns:1fr;}
    .unit-actions button{flex:1 1 100%;}
  }
  @media (max-width:640px){
    .unit-actions.preview-actions{flex-direction:column;}
    .map-preview__frame iframe{aspect-ratio:16 / 9;}
  }
</style>
</head>
<body>
<div class="shell">
  <header>
    <h1>VeoLink · Painel de Unidades</h1>
    <p>Controle de acesso corporativo para técnicos visualizarem endereços e navegação.</p>
  </header>

  <section class="layout">
    <div class="card stack" id="authCard">
      <div class="status hidden" id="sessionInfo">
        <div>
          <div>Conectado como <strong id="sessionUser">-</strong></div>
          <small class="badge" id="sessionRole">-</small>
        </div>
        <span class="spacer"></span>
        <button id="btnLogout" class="secondary" type="button">Sair</button>
      </div>

      <form id="loginForm" class="stack">
        <h2>Acesso seguro</h2>
        <div class="grid two">
          <label>Usuário<input type="text" id="loginUser" autocomplete="username" required></label>
          <label>Senha<input type="password" id="loginPass" autocomplete="current-password" required></label>
        </div>
        <button type="submit">Entrar</button>
        
      </form>

      <div id="userAdmin" class="hidden">
        <div class="toolbar" style="justify-content:space-between">
          <h2>Gerenciar logins</h2>
          <button id="toggleUserForm" class="secondary" type="button">Novo login</button>
        </div>
        <form id="createUserForm" class="stack hidden">
          <div class="grid two">
            <label>Usuário<input id="userName" required></label>
            <label>Senha<input id="userPass" required></label>
          </div>
          <label>Perfil
            <select id="userRole">
              <option value="tecnico">Técnico</option>
              <option value="supervisor">Supervisor</option>
              <option value="admin">Administrador</option>
            </select>
          </label>
          <button type="submit">Salvar login</button>
        </form>
        <ul id="userList" class="list"></ul>
      </div>
    </div>

    <div class="card stack hidden" id="appCard">
      <div class="toolbar">
        <input type="search" id="searchBox" placeholder="Buscar unidade, cidade ou observação">
        <select id="filterState">
          <option value="">UF: todas</option>
          <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option>
          <option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option>
          <option>MT</option><option>MS</option><option>MG</option><option>PA</option><option>PB</option>
          <option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
          <option>RS</option><option>RO</option><option>RR</option><option>SC</option><option>SP</option>
          <option>SE</option><option>TO</option>
        </select>
        <span class="floating-msg" id="resultInfo"></span>
      </div>

      <form id="unitForm" class="unit-editor hidden">
        <div class="unit-editor__header">
          <div>
            <h2>Cadastro de unidades</h2>
            <p class="muted">Fluxo exclusivo para supervisores e administradores da VeoLink.</p>
          </div>
          <span class="badge">Acesso restrito</span>
        </div>
        <div class="unit-editor__grid">
          <div class="unit-block">
            <h3>Identificação</h3>
            <label>Nome da unidade
              <input id="unitName" required placeholder="Ex.: Loja Centro">
            </label>
            <label>UF
              <select id="unitState" required>
                <option value="">Selecione</option>
                <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option>
                <option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option>
                <option>MT</option><option>MS</option><option>MG</option><option>PA</option><option>PB</option>
                <option>PR</option><option>PE</option><option>PI</option><option>RJ</option><option>RN</option>
                <option>RS</option><option>RO</option><option>RR</option><option>SC</option><option>SP</option>
                <option>SE</option><option>TO</option>
              </select>
            </label>
          </div>
          <div class="unit-block">
            <h3>Localização</h3>
            <label>Endereço completo
              <textarea id="unitAddress" required placeholder="Rua, número, bairro, cidade"></textarea>
            </label>
            <label>Observações
              <textarea id="unitNotes" placeholder="Informações adicionais, ponto de referência..."></textarea>
            </label>
          </div>
        </div>
        <div class="unit-editor__actions">
          <button type="submit">Salvar unidade</button>
        </div>
      </form>

      <div class="workspace">
        <div class="workspace-main">
          <h3>Unidades disponíveis</h3>
          <p class="muted">Selecione uma unidade para visualizar o trajeto e enviar para o Maps ou Waze.</p>
          <ul id="unitList" class="list"></ul>
        </div>
        <aside class="workspace-preview" aria-live="polite">
          <div>
            <p class="muted" style="margin:0">Rotas rápidas</p>
            <h3>Pré-visualização do mapa</h3>
          </div>
          <div class="map-preview__frame">
            <iframe id="mapFrame" title="Mapa corporativo" src="about:blank" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            <div class="map-preview__empty" id="previewEmpty">Selecione uma unidade para conferir a prévia do trajeto.</div>
          </div>
          <div class="map-preview__info hidden" id="previewDetail">
            <div>
              <p class="muted" style="margin:0">Unidade selecionada</p>
              <strong id="previewName">-</strong>
              <p class="muted" id="previewAddress"></p>
              <p class="muted" id="previewNotes"></p>
            </div>
            <span class="badge" id="previewState"></span>
          </div>
          <div class="unit-actions preview-actions">
            <button class="secondary" type="button" id="previewBtnMaps" disabled>Abrir no Google Maps</button>
            <button class="secondary" type="button" id="previewBtnWaze" disabled>Abrir no Waze</button>
            <button class="secondary" type="button" id="previewBtnCopy" disabled>Copiar dados</button>
          </div>
        </aside>
      </div>
    </div>
  </section>
</div>

<template id="unitTemplate">
  <li class="unit">
    <header>
      <div>
        <strong class="unit-title"></strong>
        <div class="muted unit-address"></div>
      </div>
      <span class="badge unit-state"></span>
    </header>
    <p class="muted unit-notes"></p>
    <div class="unit-actions">
      <button class="secondary btn-maps" type="button">Google Maps</button>
      <button class="secondary btn-waze" type="button">Waze</button>
      <button class="secondary btn-copy" type="button">Copiar infos</button>
      <button class="danger btn-delete hidden" type="button">Remover</button>
    </div>
  </li>
</template>

<template id="userItemTemplate">
  <li class="unit">
    <header>
      <strong class="user-name"></strong>
      <span class="badge user-role"></span>
    </header>
  </li>
</template>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbw0HuJvERdsxwKU4pCDyeqpBg0VUB1aPG2LGHQ2lRuy2X9W1TQGlgPFUpbEb5qQNUNimA/exec';
const ROLES = { ADMIN:'admin', SUPERVISOR:'supervisor', TECNICO:'tecnico' };
const LABEL = { [ROLES.ADMIN]:'Administrador', [ROLES.SUPERVISOR]:'Supervisor', [ROLES.TECNICO]:'Técnico' };
const LS_USERS = 'veolink.users';
const LS_SESSION = 'veolink.session';
let currentUser = null;
let UNIT_CACHE = [];
let unitsLoading = false;
let unitsLoadedOnce = false;
let selectedUnitKey = null;

const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => [...el.querySelectorAll(s)];
const unitTpl = qs('#unitTemplate');
const userTpl = qs('#userItemTemplate');
const previewEls = {
  frame: qs('#mapFrame'),
  empty: qs('#previewEmpty'),
  detail: qs('#previewDetail'),
  name: qs('#previewName'),
  address: qs('#previewAddress'),
  notes: qs('#previewNotes'),
  state: qs('#previewState'),
  btnMaps: qs('#previewBtnMaps'),
  btnWaze: qs('#previewBtnWaze'),
  btnCopy: qs('#previewBtnCopy')
};

function unitKey(unit){
  if (!unit) return '';
  if (unit.id !== undefined && unit.id !== null) return String(unit.id);
  return [unit.name || '', unit.state || '', unit.address || ''].join('|');
}

function setPreviewActionsDisabled(disabled){
  [previewEls.btnMaps, previewEls.btnWaze, previewEls.btnCopy].forEach(btn=>{
    if (!btn) return;
    btn.disabled = disabled;
  });
}

function updatePreview(unit){
  if (!previewEls.frame || !previewEls.detail || !previewEls.empty) return;
  const hasUnit = Boolean(unit);
  previewEls.detail.classList.toggle('hidden', !hasUnit);
  previewEls.empty.classList.toggle('hidden', hasUnit);
  setPreviewActionsDisabled(!hasUnit);
  if (!hasUnit){
    previewEls.frame.src = 'about:blank';
    previewEls.name.textContent = '-';
    previewEls.address.textContent = '';
    previewEls.notes.textContent = '';
    previewEls.state.textContent = '';
    return;
  }
  previewEls.name.textContent = unit.name || 'Unidade sem nome';
  previewEls.address.textContent = unit.address || 'Sem endereço cadastrado.';
  previewEls.notes.textContent = unit.notes ? `Obs.: ${unit.notes}` : 'Sem observações registradas.';
  previewEls.state.textContent = unit.state || '--';
  if (unit.address){
    previewEls.frame.src = `https://maps.google.com/maps?q=${encodeURIComponent(unit.address)}&output=embed`;
  }else{
    previewEls.frame.src = 'about:blank';
  }
}

function highlightSelection(){
  qsa('[data-unit-key]').forEach(el=>{
    el.classList.toggle('selected', !!selectedUnitKey && el.dataset.unitKey === selectedUnitKey);
  });
}

function selectUnit(unit){
  selectedUnitKey = unit ? unitKey(unit) : null;
  updatePreview(unit || null);
  highlightSelection();
}

function getSelectedUnit(){
  if (!selectedUnitKey) return null;
  return UNIT_CACHE.find(u => unitKey(u) === selectedUnitKey) || null;
}

function navigationUrl(type, address){
  const encoded = encodeURIComponent(address);
  return type === 'waze'
    ? `https://waze.com/ul?q=${encoded}&navigate=yes`
    : `https://www.google.com/maps/search/?api=1&query=${encoded}`;
}

function openNavigation(type, unit=getSelectedUnit()){
  if (!unit || !unit.address) return;
  window.open(navigationUrl(type, unit.address), '_blank');
}

async function copyUnit(unit=getSelectedUnit()){
  if (!unit) return;
  const text = `Unidade: ${unit.name || '-'}\nUF: ${unit.state || '-'}\nEndereço: ${unit.address || '-'}\nObs: ${unit.notes || '---'}`;
  try{
    await navigator.clipboard.writeText(text);
    alert('Informações copiadas.');
  }catch{
    alert('Não foi possível copiar.');
  }
}

function loadUsers(){
  try{ return JSON.parse(localStorage.getItem(LS_USERS) || '[]'); }
  catch{ return []; }
}
function saveUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
function ensureAdmin(){
  const users = loadUsers();
  if (!users.some(u => u.role === ROLES.ADMIN)){
    users.push({ user:'admin', pass:'admin123', role:ROLES.ADMIN });
    saveUsers(users);
  }
}
async function apiList(){
  const res = await fetch(`${API_URL}?nocache=${Date.now()}`,{
    method:'GET',
    mode:'cors',
    redirect:'follow',
    credentials:'omit',
    cache:'no-store'
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error);
  return json.data || [];
}
async function apiCreate(rec){
  const res = await fetch(API_URL,{
    method:'POST',
    mode:'cors',
    redirect:'follow',
    credentials:'omit',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify({ action:'create', ...rec })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error);
  return json;
}
async function apiDelete(id){
  const res = await fetch(API_URL,{
    method:'POST',
    mode:'cors',
    redirect:'follow',
    credentials:'omit',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify({ action:'delete', id })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  if (json.error) throw new Error(json.error);
  return json;
}
async function fetchUnitsFromApi(){
  if (!currentUser) return;
  unitsLoading = true;
  renderUnits();
  try{
    UNIT_CACHE = await apiList();
    unitsLoadedOnce = true;
  }catch(err){
    console.error(err);
    alert('Falha ao carregar unidades: ' + err.message);
    UNIT_CACHE = [];
  }finally{
    unitsLoading = false;
    renderUnits();
  }
}
function persistSession(user){
  currentUser = { user:user.user, role:user.role };
  localStorage.setItem(LS_SESSION, JSON.stringify(currentUser));
}
function restoreSession(){
  try{ currentUser = JSON.parse(localStorage.getItem(LS_SESSION) || 'null'); }
  catch{ currentUser = null; }
}
function clearSession(){ currentUser=null; localStorage.removeItem(LS_SESSION); }
function canManageUnits(){ return currentUser && (currentUser.role===ROLES.ADMIN || currentUser.role===ROLES.SUPERVISOR); }
function canManageUsers(){ return currentUser && currentUser.role===ROLES.ADMIN; }

function updateUI(){
  const sessionInfo = qs('#sessionInfo');
  const loginForm = qs('#loginForm');
  const appCard = qs('#appCard');
  const unitForm = qs('#unitForm');
  const userAdmin = qs('#userAdmin');
  if (currentUser){
    sessionInfo.classList.remove('hidden');
    loginForm.classList.add('hidden');
    appCard.classList.remove('hidden');
    qs('#sessionUser').textContent = currentUser.user;
    qs('#sessionRole').textContent = LABEL[currentUser.role] || currentUser.role;
    unitForm.classList.toggle('hidden', !canManageUnits());
    userAdmin.classList.toggle('hidden', !canManageUsers());
    renderUsers();
    if (!unitsLoadedOnce){
      fetchUnitsFromApi();
    }else{
      renderUnits();
    }
  }else{
    sessionInfo.classList.add('hidden');
    loginForm.classList.remove('hidden');
    appCard.classList.add('hidden');
    userAdmin.classList.add('hidden');
    UNIT_CACHE = [];
    unitsLoadedOnce = false;
    unitsLoading = false;
    renderUnits();
  }
}
function renderUsers(){
  const wrap = qs('#userList');
  wrap.innerHTML = '';
  if (!canManageUsers()) return;
  loadUsers().forEach(u=>{
    const item = userTpl.content.cloneNode(true);
    item.querySelector('.user-name').textContent = u.user;
    item.querySelector('.user-role').textContent = LABEL[u.role] || u.role;
    wrap.appendChild(item);
  });
}

function filteredUnits(){
  const term = qs('#searchBox').value.trim().toLowerCase();
  const uf = qs('#filterState').value;
  return UNIT_CACHE.filter(u=>{
    const matchesTerm = !term || [u.name,u.address,u.notes].some(v=> (v||'').toLowerCase().includes(term));
    const matchesUF = !uf || u.state === uf;
    return matchesTerm && matchesUF;
  });
}

function renderUnits(){

  const list = qs('#unitList');

  if (!list) return;

  list.innerHTML='';

  const data = filteredUnits();

  const resultInfo = qs('#resultInfo');

  if (resultInfo){

    if (unitsLoading){

      resultInfo.textContent = 'Carregando unidades...';

    }else{

      resultInfo.textContent = data.length ? `${data.length} unidades exibidas` : 'Nenhuma unidade encontrada';

    }

  }

  data.forEach(unit=>{

    const row = unitTpl.content.cloneNode(true);

    const card = row.querySelector('.unit');

    card.dataset.unitKey = unitKey(unit);

    card.addEventListener('click', e=>{

      if (e.target.closest('button')) return;

      selectUnit(unit);

    });

    row.querySelector('.unit-title').textContent = unit.name;

    row.querySelector('.unit-address').textContent = unit.address;

    row.querySelector('.unit-notes').textContent = unit.notes || 'Sem observações';

    row.querySelector('.unit-state').textContent = unit.state;

    row.querySelector('.btn-maps').onclick = e=>{

      e.stopPropagation();

      openNavigation('maps', unit);

    };

    row.querySelector('.btn-waze').onclick = e=>{

      e.stopPropagation();

      openNavigation('waze', unit);

    };

    row.querySelector('.btn-copy').onclick = e=>{

      e.stopPropagation();

      copyUnit(unit);

    };

    const btnDel = row.querySelector('.btn-delete');

    if (canManageUnits()){

      btnDel.classList.remove('hidden');

      btnDel.onclick = async e=>{

        e.stopPropagation();

        if (!confirm('Remover esta unidade?')) return;

        try{

          await apiDelete(unit.id);

          await fetchUnitsFromApi();

        }catch(err){

          alert('Erro ao remover: ' + err.message);

        }

      };

    }else{

      btnDel.classList.add('hidden');

    }

    list.appendChild(row);

  });

  if (data.length){

    const current = selectedUnitKey ? data.find(u=>unitKey(u) === selectedUnitKey) : null;

    selectUnit(current || data[0]);

  }else{

    selectUnit(null);

  }

}



document.addEventListener('DOMContentLoaded', ()=>{
  ensureAdmin();
  restoreSession();
  updateUI();

  qs('#loginForm').addEventListener('submit',e=>{
    e.preventDefault();
    const user = qs('#loginUser').value.trim();
    const pass = qs('#loginPass').value.trim();
    const found = loadUsers().find(u=>u.user.toLowerCase()===user.toLowerCase());
    if (!found || found.pass!==pass){ alert('Credenciais inválidas.'); return; }
    persistSession(found);
    e.target.reset();
    updateUI();
  });

  qs('#btnLogout').addEventListener('click', ()=>{
    clearSession();
    updateUI();
  });

  qs('#toggleUserForm').addEventListener('click', ()=>{
    qs('#createUserForm').classList.toggle('hidden');
  });

  qs('#createUserForm').addEventListener('submit', e=>{
    e.preventDefault();
    const username = qs('#userName').value.trim();
    const password = qs('#userPass').value.trim();
    const role = qs('#userRole').value;
    if (!username || !password) return alert('Preencha os campos.');
    const users = loadUsers();
    if (users.some(u=>u.user.toLowerCase()===username.toLowerCase())){
      alert('Usuário já existe.'); return;
    }
    users.push({ user:username, pass:password, role });
    saveUsers(users);
    e.target.reset();
    renderUsers();
    alert('Login criado.');
  });

  qs('#unitForm').addEventListener('submit', async e=>{
    e.preventDefault();
    if (!canManageUnits()) return alert('Sem permissão.');
    const rec = {
      name:qs('#unitName').value.trim(),
      state:qs('#unitState').value,
      address:qs('#unitAddress').value.trim(),
      notes:qs('#unitNotes').value.trim()
    };
    if (!rec.name || !rec.state || !rec.address) return alert('Preencha todos os campos obrigatórios.');
    try{
      await apiCreate(rec);
      e.target.reset();
      await fetchUnitsFromApi();
      alert('Unidade salva.');
    }catch(err){
      alert('Erro ao salvar unidade: ' + err.message);
    }
  });

  if (previewEls.btnMaps){
    previewEls.btnMaps.addEventListener('click', ()=> openNavigation('maps'));
  }
  if (previewEls.btnWaze){
    previewEls.btnWaze.addEventListener('click', ()=> openNavigation('waze'));
  }
  if (previewEls.btnCopy){
    previewEls.btnCopy.addEventListener('click', ()=> copyUnit());
  }

  qs('#searchBox').addEventListener('input', renderUnits);
  qs('#filterState').addEventListener('change', renderUnits);
});
</script>
</body>
</html>
